image: node:10

stages:
  - build
  - deploy

cache:
  paths:
    - node_modules/

.Build template: &build_template
  stage: build
  before_script:
    - npm ci
  script:
    - npm run build
  artifacts:
    name: build
    paths:
      - build

.Deploy template: &deploy_template
  image: python:latest
  stage: deploy
  before_script:
    - pip install awscli
    - npm install -g create-env
  script:
    - aws s3 sync build s3://$AWS_BUCKET_NAME

Dev build job:
  except:
    refs:
      - master
  <<: *build_template

Dev deploy job:
  script:
    - create-env --env-file .env --env-prefix DEV_
  only:
    refs:
      - development
    changes:
      - src/**/*
      - static/**/*
      - content/**/*
      - package.json
      - package-lock.json
      - .gitlab-ci.yml
  <<: *deploy_template

Test build job:
  only:
    refs:
      - test
  <<: *build_template

Test deploy job:
  only:
    refs:
      - test
    changes:
      - src/**/*
      - static/**/*
      - content/**/*
      - package.json
      - package-lock.json
      - .gitlab-ci.yml
  <<: *deploy_template
